<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>CAO VĂN NAM</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --pink: #ec4899;
  --pink-dark: #db2777;
  --bg-white: #ffffff;
  --bg-light: #f8fafc;
  --bg-gradient: linear-gradient(135deg, #f0f9ff 0%, #fdf2f8 100%);
  --card-bg: #ffffff;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --border: #e2e8f0;
  --success: #10b981;
  --error: #ef4444;
  --warning: #f59e0b;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  --shadow-lg: 0 10px 25px rgba(59, 130, 246, 0.1);
  --radius: 16px;
  --radius-lg: 20px;
  --radius-sm: 12px;
  --transition: all 0.25s ease;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-white);
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.5;
  overflow-x: hidden;
  padding-bottom: 80px;
}

/* Header */
.app-header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: var(--bg-white);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  border-bottom: 1px solid var(--border);
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
}

.app-logo {
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--primary), var(--pink));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 18px;
}

.logo-text {
  font-size: 18px;
  font-weight: 700;
  background: linear-gradient(to right, var(--primary), var(--pink));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

.header-action {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  border: none;
  background: var(--bg-light);
  color: var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  transition: var(--transition);
}

.header-action:active {
  background: var(--primary);
  color: white;
  transform: scale(0.95);
}

/* Main Content */
.main-content {
  padding: 76px 16px 16px;
  max-width: 500px;
  margin: 0 auto;
}

/* Welcome Section */
.welcome-section {
  text-align: center;
  padding: 20px 0 30px;
}

.welcome-title {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 8px;
  background: linear-gradient(to right, var(--primary), var(--pink));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

.welcome-subtitle {
  color: var(--text-secondary);
  font-size: 15px;
  max-width: 300px;
  margin: 0 auto;
}

/* Input Card */
.input-card {
  background: var(--card-bg);
  border-radius: var(--radius-lg);
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.input-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}

.input-icon {
  width: 48px;
  height: 48px;
  border-radius: 14px;
  background: linear-gradient(135deg, var(--primary), var(--pink));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 20px;
}

.input-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
}

.input-group {
  margin-bottom: 20px;
}

.input-label {
  display: block;
  font-size: 14px;
  margin-bottom: 8px;
  color: var(--text-primary);
  font-weight: 500;
}

.input-wrapper {
  position: relative;
}

.input-wrapper i {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--primary);
  font-size: 18px;
}

.input-field {
  width: 100%;
  padding: 16px 16px 16px 48px;
  background: var(--bg-light);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-size: 16px;
  transition: var(--transition);
  font-family: inherit;
}

.input-field:focus {
  outline: none;
  border-color: var(--primary);
  background: white;
}

.input-hint {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* Submit Button */
.submit-btn {
  width: 100%;
  padding: 18px;
  background: linear-gradient(135deg, var(--primary), var(--pink));
  border: none;
  border-radius: var(--radius);
  color: white;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
}

.submit-btn:active {
  transform: translateY(2px);
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
}

/* Result Card */
.result-card {
  background: var(--card-bg);
  border-radius: var(--radius-lg);
  padding: 24px;
  margin-top: 20px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  display: none;
}

.result-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}

.result-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
}

/* Result Display */
.result-display {
  background: var(--bg-light);
  border-radius: var(--radius);
  padding: 24px;
  border: 1px solid var(--border);
  text-align: center;
  margin-bottom: 20px;
}

.result-status {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.status-success {
  color: var(--success);
  background: linear-gradient(135deg, var(--success), #059669);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

.status-error {
  color: var(--error);
}

.status-waiting {
  color: var(--warning);
}

.result-user-info {
  background: white;
  border-radius: var(--radius-sm);
  padding: 18px;
  margin-bottom: 16px;
  border: 1px solid var(--border);
}

.result-name {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text-primary);
}

.result-username {
  font-size: 16px;
  color: var(--primary);
  font-weight: 500;
}

.result-timer {
  background: rgba(245, 158, 11, 0.1);
  border-radius: var(--radius-sm);
  padding: 16px;
  margin-top: 16px;
  border: 1px solid rgba(245, 158, 11, 0.2);
  display: none;
}

.timer-title {
  font-size: 14px;
  color: var(--warning);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.timer-countdown {
  font-size: 24px;
  font-weight: 700;
  color: var(--warning);
  font-family: 'Menlo', monospace;
}

/* Raw JSON Result */
.raw-result {
  background: var(--bg-light);
  border-radius: var(--radius);
  padding: 20px;
  font-family: 'Menlo', 'Monaco', monospace;
  font-size: 13px;
  line-height: 1.6;
  overflow-x: auto;
  border: 1px solid var(--border);
  color: var(--text-primary);
  max-height: 200px;
  overflow-y: auto;
  display: none;
  margin-top: 16px;
}

/* Mobile Config Button */
.download-config-btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, var(--success), #0d9488);
  border: none;
  border-radius: var(--radius);
  color: white;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: none;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-top: 16px;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.download-config-btn:active {
  transform: translateY(2px);
  box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
}

.download-config-btn.show {
  display: flex;
}

.result-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

.action-btn {
  flex: 1;
  padding: 14px;
  background: var(--bg-light);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.action-btn:active {
  background: var(--primary);
  color: white;
  transform: scale(0.98);
}

.toggle-raw-btn {
  width: 100%;
  padding: 12px;
  background: var(--bg-light);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-secondary);
  font-size: 13px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  margin-top: 12px;
}

.toggle-raw-btn:active {
  background: rgba(59, 130, 246, 0.1);
}

/* Bottom Navigation */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 70px;
  background: var(--bg-white);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 100;
  padding-bottom: env(safe-area-inset-bottom);
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 12px;
  border-radius: var(--radius);
  color: var(--text-secondary);
  text-decoration: none;
  transition: var(--transition);
  min-width: 70px;
}

.nav-item:active {
  background: var(--bg-light);
}

.nav-item.active {
  color: var(--primary);
}

.nav-icon {
  font-size: 20px;
}

.nav-text {
  font-size: 11px;
  font-weight: 500;
}

/* Slide Menu */
.menu-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  z-index: 200;
  display: none;
  animation: fadeIn 0.3s ease;
}

.menu {
  position: fixed;
  top: 0;
  right: -100%;
  width: 85%;
  max-width: 340px;
  height: 100%;
  background: var(--bg-white);
  z-index: 300;
  transition: var(--transition);
  overflow-y: auto;
  box-shadow: -5px 0 25px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
}

.menu-header {
  padding: 20px 16px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(135deg, var(--primary), var(--pink));
  color: white;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.menu-header h2 {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 18px;
}

.menu-content {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
}

.menu-section {
  margin-bottom: 24px;
}

.menu-section h3 {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.history-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.history-item {
  background: var(--bg-light);
  border-radius: var(--radius);
  padding: 16px;
  border: 1px solid var(--border);
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.history-item:active {
  background: rgba(59, 130, 246, 0.05);
  transform: translateX(2px);
}

.history-info {
  flex: 1;
}

.history-username {
  font-weight: 600;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-primary);
  font-size: 14px;
}

.history-meta {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 12px;
  color: var(--text-secondary);
}

.history-status {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 500;
}

.status-success {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
}

.status-error {
  background: rgba(239, 68, 68, 0.1);
  color: var(--error);
}

.history-actions {
  display: flex;
  gap: 6px;
}

.icon-btn {
  width: 34px;
  height: 34px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: white;
  border: 1px solid var(--border);
  color: var(--text-secondary);
  cursor: pointer;
  transition: var(--transition);
  font-size: 14px;
}

.icon-btn:active {
  background: var(--primary);
  color: white;
  transform: scale(0.95);
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-secondary);
}

.empty-state i {
  font-size: 40px;
  margin-bottom: 12px;
  color: var(--primary);
  opacity: 0.4;
}

.empty-state p {
  font-size: 14px;
}

/* Confirmation Modal */
.confirm-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 400;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  animation: fadeIn 0.2s ease;
}

.confirm-box {
  background: var(--bg-white);
  border-radius: var(--radius-lg);
  padding: 24px;
  max-width: 320px;
  width: 100%;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  animation: slideUp 0.3s ease;
}

.confirm-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.confirm-message {
  color: var(--text-secondary);
  font-size: 14px;
  margin-bottom: 24px;
  line-height: 1.5;
}

.confirm-actions {
  display: flex;
  gap: 12px;
}

.confirm-btn {
  flex: 1;
  padding: 12px;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  border: none;
}

.confirm-btn.cancel {
  background: var(--bg-light);
  color: var(--text-secondary);
}

.confirm-btn.cancel:active {
  background: #e5e7eb;
}

.confirm-btn.delete {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
}

.confirm-btn.delete:active {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  transform: scale(0.98);
}

/* Toast Notification */
.toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 14px 20px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 500;
  opacity: 0;
  transition: var(--transition);
  max-width: 90%;
  width: fit-content;
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

.toast-success {
  border-left: 4px solid var(--success);
}

.toast-error {
  border-left: 4px solid var(--error);
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.spinner {
  width: 18px;
  height: 18px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s linear infinite;
}

/* Responsive */
@media (min-width: 768px) {
  .main-content {
    padding-top: 90px;
  }
  
  .bottom-nav {
    display: none;
  }
  
  body {
    padding-bottom: 0;
  }
}
</style>
</head>

<body>
<!-- Header -->
<header class="app-header">
  <div class="app-logo">
    <div class="logo-icon">
      <i class="fas fa-paper-plane"></i>
    </div>
    <div class="logo-text">CAO VĂN NAM</div>
  </div>
  
  <button class="header-action" id="historyBtn" title="Lịch sử">
    <i class="fas fa-history"></i>
  </button>
</header>

<!-- Main Content -->
<main class="main-content">
  <!-- Welcome Section -->
  <section class="welcome-section">
    <h1 class="welcome-title">Gửi Username</h1>
    <p class="welcome-subtitle">Nhập username LOCKET để gửi đến hệ thống</p>
  </section>

  <!-- Input Card -->
  <div class="input-card">
    <div class="input-header">
      <div class="input-icon">
        <i class="fas fa-user-circle"></i>
      </div>
      <h2 class="input-title">Username LOCKET</h2>
    </div>
    
    <div class="input-group">
      <label class="input-label">Tên người dùng</label>
      <div class="input-wrapper">
        <i class="fas fa-at"></i>
        <input type="text" class="input-field" id="usernameInput" placeholder="locketgold" autocomplete="off">
      </div>
      <div class="input-hint">
        <i class="fas fa-info-circle"></i>
        Nhập username không bao gồm ký tự @
      </div>
    </div>
    
    <button class="submit-btn" id="sendBtn">
      <i class="fas fa-paper-plane"></i>
      Gửi Username
    </button>
  </div>

  <!-- Result Card -->
  <div class="result-card" id="resultCard">
    <div class="result-header">
      <h2 class="result-title">
        <i class="fas fa-code"></i>
        Kết quả
      </h2>
      <button class="header-action" id="copyBtn" title="Sao chép">
        <i class="fas fa-copy"></i>
      </button>
    </div>
    
    <!-- Result Display -->
    <div class="result-display" id="resultDisplay">
      <div class="result-status" id="resultStatus">
        <i class="fas fa-spinner fa-spin"></i>
        Đang xử lý...
      </div>
      
      <div class="result-user-info" id="resultUserInfo">
        <div class="result-name" id="resultName">-</div>
        <div class="result-username" id="resultUsername">-</div>
      </div>
      
      <div class="result-timer" id="resultTimer">
        <div class="timer-title">
          <i class="fas fa-clock"></i>
          Thử lại sau:
        </div>
        <div class="timer-countdown" id="timerCountdown">00:00</div>
      </div>
    </div>
    
    <!-- Raw JSON Result -->
    <div class="raw-result" id="rawResult">
      <!-- Raw JSON will appear here -->
    </div>
    
    <!-- Toggle Raw JSON Button -->
    <button class="toggle-raw-btn" id="toggleRawBtn">
      <i class="fas fa-eye"></i>
      Xem JSON gốc
    </button>
    
    <!-- Mobile Config Download Button -->
    <button class="download-config-btn" id="downloadConfigBtn">
      <i class="fas fa-download"></i>
      Tải File .mobileconfig
    </button>
    
    <div class="result-actions">
      <button class="action-btn" id="closeResultBtn">
        <i class="fas fa-times"></i>
        Đóng
      </button>
      <button class="action-btn" id="sendAgainBtn">
        <i class="fas fa-redo"></i>
        Gửi lại
      </button>
    </div>
  </div>
</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
  <a href="#" class="nav-item active" id="navSend">
    <i class="fas fa-paper-plane nav-icon"></i>
    <span class="nav-text">Gửi</span>
  </a>
  <a href="#" class="nav-item" id="navHistory">
    <i class="fas fa-history nav-icon"></i>
    <span class="nav-text">Lịch sử</span>
  </a>
</nav>

<!-- Slide Menu -->
<div class="menu-overlay" id="menuOverlay"></div>
<div class="menu" id="menu">
  <div class="menu-header">
    <h2>
      <i class="fas fa-history"></i>
      Lịch sử gửi
    </h2>
    <button class="header-action" id="closeMenuBtn">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div class="menu-content">
    <div class="menu-section">
      <h3>Hoạt động gần đây</h3>
      <div class="history-list" id="historyList">
        <!-- History items will be added here -->
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="confirm-modal" id="confirmModal">
  <div class="confirm-box">
    <h3 class="confirm-title" id="confirmTitle">Xác nhận xoá</h3>
    <p class="confirm-message" id="confirmMessage">Bạn có chắc chắn muốn xoá mục này?</p>
    <div class="confirm-actions">
      <button class="confirm-btn cancel" id="confirmCancel">Huỷ</button>
      <button class="confirm-btn delete" id="confirmDelete">Xoá</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
  <i class="fas fa-check-circle" id="toastIcon"></i>
  <span id="toastMessage">Thông báo</span>
</div>

<script>
// Configuration
const API_ENDPOINT = "https://damp-unit-e8d0.camsempai5.workers.dev/";
const STORAGE_KEY = "users_history";
const MAX_HISTORY_ITEMS = 20;

// State
let deleteIndex = null;
let currentPage = 'send';
let currentUsername = '';
let lastSuccessfulUsername = '';
let countdownTimer = null;
let remainingSeconds = 0;

// DOM Elements
const usernameInput = document.getElementById('usernameInput');
const sendBtn = document.getElementById('sendBtn');
const resultCard = document.getElementById('resultCard');
const resultDisplay = document.getElementById('resultDisplay');
const resultStatus = document.getElementById('resultStatus');
const resultName = document.getElementById('resultName');
const resultUsername = document.getElementById('resultUsername');
const resultTimer = document.getElementById('resultTimer');
const timerCountdown = document.getElementById('timerCountdown');
const rawResult = document.getElementById('rawResult');
const toggleRawBtn = document.getElementById('toggleRawBtn');
const copyBtn = document.getElementById('copyBtn');
const closeResultBtn = document.getElementById('closeResultBtn');
const sendAgainBtn = document.getElementById('sendAgainBtn');
const downloadConfigBtn = document.getElementById('downloadConfigBtn');
const historyBtn = document.getElementById('historyBtn');
const closeMenuBtn = document.getElementById('closeMenuBtn');
const menuOverlay = document.getElementById('menuOverlay');
const menu = document.getElementById('menu');
const historyList = document.getElementById('historyList');
const confirmModal = document.getElementById('confirmModal');
const confirmTitle = document.getElementById('confirmTitle');
const confirmMessage = document.getElementById('confirmMessage');
const confirmCancel = document.getElementById('confirmCancel');
const confirmDelete = document.getElementById('confirmDelete');
const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toastMessage');
const toastIcon = document.getElementById('toastIcon');
const navSend = document.getElementById('navSend');
const navHistory = document.getElementById('navHistory');

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  loadHistory();
  setupEventListeners();
  showToast('Sẵn sàng gửi username!', 'success');
});

// Event Listeners
function setupEventListeners() {
  sendBtn.addEventListener('click', sendUsername);
  usernameInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendUsername();
  });
  
  copyBtn.addEventListener('click', copyResult);
  closeResultBtn.addEventListener('click', closeResult);
  sendAgainBtn.addEventListener('click', sendAgain);
  downloadConfigBtn.addEventListener('click', downloadMobileConfig);
  toggleRawBtn.addEventListener('click', toggleRawResult);
  
  historyBtn.addEventListener('click', openMenu);
  navHistory.addEventListener('click', function(e) {
    e.preventDefault();
    openMenu();
    setActiveNav('history');
  });
  navSend.addEventListener('click', function(e) {
    e.preventDefault();
    closeMenu();
    setActiveNav('send');
  });
  
  closeMenuBtn.addEventListener('click', closeMenu);
  menuOverlay.addEventListener('click', closeMenu);
  
  confirmCancel.addEventListener('click', closeConfirm);
  confirmDelete.addEventListener('click', confirmDeleteAction);
}

// Navigation
function setActiveNav(page) {
  currentPage = page;
  navSend.classList.toggle('active', page === 'send');
  navHistory.classList.toggle('active', page === 'history');
}

// Menu Functions
function openMenu() {
  menu.style.right = '0';
  menuOverlay.style.display = 'block';
  setTimeout(() => menuOverlay.style.opacity = '1', 10);
  setActiveNav('history');
}

function closeMenu() {
  menu.style.right = '-100%';
  menuOverlay.style.opacity = '0';
  setTimeout(() => menuOverlay.style.display = 'none', 300);
  setActiveNav('send');
}

// Load History
function loadHistory() {
  const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  
  if (history.length === 0) {
    historyList.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-history"></i>
        <p>Chưa có lịch sử gửi nào</p>
        <p>Gửi username đầu tiên của bạn!</p>
      </div>
    `;
    return;
  }
  
  let historyHTML = '';
  history.forEach((item, index) => {
    historyHTML += `
      <div class="history-item" data-index="${index}">
        <div class="history-info" onclick="useHistoryItem('${item.username}')">
          <div class="history-username">
            <i class="fas fa-user"></i>
            ${item.username}
          </div>
          <div class="history-meta">
            <span>${item.time}</span>
            <span class="history-status ${item.success ? 'status-success' : 'status-error'}">
              <i class="fas ${item.success ? 'fa-check-circle' : 'fa-times-circle'}"></i>
              ${item.success ? 'Thành công' : 'Thất bại'}
            </span>
          </div>
        </div>
        <div class="history-actions">
          <button class="icon-btn" onclick="useHistoryItem('${item.username}')" title="Sử dụng lại">
            <i class="fas fa-reply"></i>
          </button>
          <button class="icon-btn" onclick="showDeleteConfirm(${index}, '${item.username}')" title="Xóa">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    `;
  });
  
  historyList.innerHTML = historyHTML;
}

// Delete Confirmation
function showDeleteConfirm(index, username) {
  deleteIndex = index;
  confirmTitle.textContent = 'Xác nhận xoá';
  confirmMessage.textContent = `Bạn có chắc chắn muốn xoá username "${username}" khỏi lịch sử?`;
  confirmModal.style.display = 'flex';
}

function closeConfirm() {
  confirmModal.style.display = 'none';
  deleteIndex = null;
}

function confirmDeleteAction() {
  if (deleteIndex !== null) {
    deleteHistoryItem(deleteIndex);
    closeConfirm();
  }
}

function deleteHistoryItem(index) {
  const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const deletedItem = history.splice(index, 1)[0];
  localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
  loadHistory();
  showToast(`Đã xóa: ${deletedItem.username}`, 'success');
}

function useHistoryItem(username) {
  usernameInput.value = username;
  closeMenu();
  setActiveNav('send');
  showToast(`Đã điền username: ${username}`, 'success');
}

// Get Current Time
function getCurrentTime() {
  const now = new Date();
  return now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) + 
         ' - ' + now.toLocaleDateString('vi-VN');
}

// Format time display
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// Start countdown timer
function startCountdown(seconds) {
  if (countdownTimer) {
    clearInterval(countdownTimer);
  }
  
  remainingSeconds = seconds;
  resultTimer.style.display = 'block';
  timerCountdown.textContent = formatTime(remainingSeconds);
  
  countdownTimer = setInterval(() => {
    remainingSeconds--;
    timerCountdown.textContent = formatTime(remainingSeconds);
    
    if (remainingSeconds <= 0) {
      clearInterval(countdownTimer);
      resultTimer.style.display = 'none';
    }
  }, 1000);
}

// Send Username
async function sendUsername() {
  const username = usernameInput.value.trim();
  
  if (!username) {
    showToast('Vui lòng nhập username', 'error');
    usernameInput.focus();
    return;
  }
  
  currentUsername = username;
  
  // Disable send button and show loading
  const originalBtnText = sendBtn.innerHTML;
  sendBtn.innerHTML = '<div class="spinner"></div> Đang gửi...';
  sendBtn.disabled = true;
  
  // Reset result display
  resultStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
  resultStatus.className = 'result-status status-waiting';
  resultName.textContent = '-';
  resultUsername.textContent = '-';
  resultTimer.style.display = 'none';
  rawResult.style.display = 'none';
  rawResult.textContent = '';
  downloadConfigBtn.classList.remove('show');
  downloadConfigBtn.style.display = 'none';
  toggleRawBtn.innerHTML = '<i class="fas fa-eye"></i> Xem JSON gốc';
  
  try {
    showToast(`Đang gửi username: ${username}`, 'success');
    
    const response = await fetch(API_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username })
    });
    
    const data = await response.json();
    
    // Display raw JSON
    rawResult.textContent = JSON.stringify(data, null, 2);
    
    // Process response data
    if (data.remaining !== undefined) {
      // API rate limited
      resultStatus.innerHTML = '<i class="fas fa-clock"></i> VUI LÒNG CHỜ';
      resultStatus.className = 'result-status status-waiting';
      resultName.textContent = 'Đã đạt giới hạn API';
      resultUsername.textContent = `Thử Lại Sau: ${data.remaining} Giây`;
      
      // Show countdown if wait_time exists
      if (data.wait_time) {
        startCountdown(data.wait_time);
      }
      
      showToast(`Giới hạn API: ${data.remaining} lượt còn lại`, 'error');
    } else if (data.success === true) {
      // Success case
      resultStatus.innerHTML = '<i class="fas fa-check-circle"></i> ĐÃ NÂNG GOLD THÀNH CÔNG';
      resultStatus.className = 'result-status status-success';
      resultName.textContent = data.name || 'Chưa xác định';
      resultUsername.innerHTML = `@${data.username || username}`;
      
      lastSuccessfulUsername = data.username || username;
      downloadConfigBtn.classList.add('show');
      downloadConfigBtn.style.display = 'flex';
      
      showToast(`Gửi thành công: ${username}`, 'success');
    } else {
      // Failure case
      resultStatus.innerHTML = '<i class="fas fa-times-circle"></i> NÂNG GOLD THẤT BẠI';
      resultStatus.className = 'result-status status-error';
      resultName.textContent = data.name || 'Chưa xác định';
      resultUsername.innerHTML = `@${data.username || username}`;
      
      showToast(`Gửi thất bại: ${username}`, 'error');
    }
    
    // Show result card
    resultCard.style.display = 'block';
    
    // Scroll to result
    setTimeout(() => {
      resultCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
    
    // Save to history
    const historyItem = {
      username: data.username || username,
      name: data.name || 'Chưa xác định',
      success: data.success === true,
      time: getCurrentTime()
    };
    
    saveToHistory(historyItem);
    
  } catch (error) {
    // Error case
    resultStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> LỖI KẾT NỐI';
    resultStatus.className = 'result-status status-error';
    resultName.textContent = 'Không thể kết nối đến server';
    resultUsername.innerHTML = `Lỗi: ${error.message}`;
    
    rawResult.textContent = `Lỗi: ${error.message}`;
    resultCard.style.display = 'block';
    showToast(`Lỗi kết nối: ${error.message}`, 'error');
  } finally {
    // Restore send button
    sendBtn.innerHTML = originalBtnText;
    sendBtn.disabled = false;
  }
}

// Toggle raw JSON view
function toggleRawResult() {
  if (rawResult.style.display === 'none') {
    rawResult.style.display = 'block';
    toggleRawBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Ẩn JSON gốc';
  } else {
    rawResult.style.display = 'none';
    toggleRawBtn.innerHTML = '<i class="fas fa-eye"></i> Xem JSON gốc';
  }
}

// Download Mobile Config
function downloadMobileConfig() {
  if (!lastSuccessfulUsername) {
    showToast('Không tìm thấy username để tạo file', 'error');
    return;
  }
  
  // Create .mobileconfig file content
  const configContent = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>PayloadDisplayName</key>
    <string>LOCKET VIP ( CAO VĂN NAM )</string>
    <key>PayloadDescription</key>
    <string>NÂNG LOCKET GOLD 15s</string>
    <key>PayloadIdentifier</key>
    <string>io.nextdns.abf777.profile</string>
    <key>PayloadScope</key>
    <string>System</string>
    <key>PayloadType</key>
    <string>Configuration</string>
    <key>PayloadUUID</key>
    <string>A1E2F262-DB73-40F6-BD22-2E42A43A3C94.abf777</string>
    <key>PayloadVersion</key>
    <integer>1</integer>
    <key>PayloadContent</key>
    <array>
      <dict>
        <key>DNSSettings</key>
        <dict>
          <key>DNSProtocol</key>
          <string>HTTPS</string>
          <key>ServerURL</key>
          <string>https://apple.dns.nextdns.io/abf777</string>
        </dict>
        <key>OnDemandRules</key>
        <array>
          <dict>
            <key>Action</key>
            <string>EvaluateConnection</string>
            <key>ActionParameters</key>
            <array>
              <dict>
                <key>DomainAction</key>
                <string>NeverConnect</string>
                <key>Domains</key>
                <array>
                  <string>captive.apple.com</string>
                  <string>dav.orange.fr</string>
                  <string>vvm.mobistar.be</string>
                  <string>vvm.mstore.msg.t-mobile.com</string>
                  <string>tma.vvm.mone.pan-net.eu</string>
                  <string>vvm.ee.co.uk</string>
                </array>
              </dict>
            </array>
          </dict>
          <dict>
            <key>Action</key>
            <string>Connect</string>
          </dict>
        </array>
        <key>PayloadType</key>
        <string>com.apple.dnsSettings.managed</string>
        <key>PayloadIdentifier</key>
        <string>io.nextdns.abf777.profile.dnsSettings.managed</string>
        <key>PayloadUUID</key>
        <string>A1E2F262-DB73-40F6-BD22-2E42A43A3C94.abf777.dnsSettings.managed</string>
        <key>PayloadDisplayName</key>
        <string>LOCKET VIP ( CAO VĂN NAM )</string>
        <key>PayloadOrganization</key>
        <string>NextDNS</string>
        <key>PayloadVersion</key>
        <integer>1</integer>
      </dict>
    </array>
  </dict>
</plist>`;

  // Create download link
  const blob = new Blob([configContent], { type: 'application/x-apple-aspen-config' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${lastSuccessfulUsername}.mobileconfig`;
  
  // Trigger download
  document.body.appendChild(a);
  a.click();
  
  // Cleanup
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 100);
  
  showToast(`Đã tải file .mobileconfig cho ${lastSuccessfulUsername}`, 'success');
}

// Generate UUID for mobileconfig
function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// Save to History
function saveToHistory(item) {
  let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  
  // Remove duplicate if exists
  history = history.filter(h => h.username !== item.username);
  
  // Add new item to beginning
  history.unshift(item);
  
  // Keep only recent items
  if (history.length > MAX_HISTORY_ITEMS) {
    history = history.slice(0, MAX_HISTORY_ITEMS);
  }
  
  localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
  loadHistory();
}

// Copy result
function copyResult() {
  const text = rawResult.textContent;
  navigator.clipboard.writeText(text)
    .then(() => showToast('Đã sao chép kết quả', 'success'))
    .catch(() => showToast('Sao chép thất bại', 'error'));
}

// Close result
function closeResult() {
  resultCard.style.display = 'none';
  downloadConfigBtn.classList.remove('show');
  downloadConfigBtn.style.display = 'none';
  rawResult.style.display = 'none';
  toggleRawBtn.innerHTML = '<i class="fas fa-eye"></i> Xem JSON gốc';
  
  // Clear timer
  if (countdownTimer) {
    clearInterval(countdownTimer);
    resultTimer.style.display = 'none';
  }
}

// Send again
function sendAgain() {
  closeResult();
  usernameInput.focus();
}

// Toast Notification
function showToast(message, type = 'success') {
  // Set toast content and style
  toastMessage.textContent = message;
  toast.className = 'toast';
  toast.classList.add(`toast-${type}`);
  
  // Set icon based on type
  if (type === 'success') {
    toastIcon.className = 'fas fa-check-circle';
  } else {
    toastIcon.className = 'fas fa-exclamation-circle';
  }
  
  // Show toast
  toast.classList.add('show');
  
  // Hide after 3 seconds
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// Utility functions for external use
window.pick = function(username) {
  usernameInput.value = username;
  closeMenu();
  setActiveNav('send');
  showToast(`Đã chọn: ${username}`, 'success');
};

window.removeUser = function(index) {
  showDeleteConfirm(index, '');
};
</script>
</body>
</html>
